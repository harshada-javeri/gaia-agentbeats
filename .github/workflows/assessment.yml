name: Run GAIA Assessment

on:
  push:
    branches:
      - main
    paths:
      - 'scenario.toml'
      - '.github/workflows/assessment.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  generate-compose:
    runs-on: ubuntu-latest
    outputs:
      compose: ${{ steps.generate.outputs.compose }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install tomli-w requests
      
      - name: Generate docker-compose.yml
        id: generate
        run: |
          python generate_compose.py --scenario scenario.toml
          echo "compose=$(cat docker-compose.yml | base64 -w 0)" >> $GITHUB_OUTPUT

  run-assessment:
    needs: generate-compose
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Set up Docker Compose
        run: |
          echo "${{ needs.generate-compose.outputs.compose }}" | base64 -d > docker-compose.yml
          cat docker-compose.yml
      
      - name: Run assessment
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker compose pull
          docker compose up --abort-on-container-exit
      
      - name: Extract results
        if: always()
        run: |
          docker compose down
          mkdir -p results
          # Results should be in output/ directory from the assessment run
          if [ -f output/results.json ]; then
            cp output/results.json results/$(date +%s).json
          fi
      
      - name: Create submission PR
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get the latest result file
            const resultsDir = 'results';
            if (!fs.existsSync(resultsDir)) {
              console.log('No results directory found');
              return;
            }
            
            const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));
            if (files.length === 0) {
              console.log('No result files found');
              return;
            }
            
            const latestFile = files.sort().pop();
            const resultsPath = path.join(resultsDir, latestFile);
            console.log(`Using results file: ${resultsPath}`);
            
            // Create a new branch for the submission
            const branchName = `submission/gaia-${Date.now()}`;
            
            // Get current HEAD
            const { data: refData } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${context.ref.split('/').pop()}`,
            });
            
            // Create new branch
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: refData.object.sha,
            });
            
            // Upload the result file
            const content = fs.readFileSync(resultsPath, 'utf-8');
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: resultsPath,
              message: `Add GAIA benchmark results`,
              content: Buffer.from(content).toString('base64'),
              branch: branchName,
            });
            
            // Create pull request
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `GAIA Assessment Results - ${new Date().toISOString()}`,
              body: `## GAIA Benchmark Assessment Results\n\nResults file: ${latestFile}\n\nMerge this PR to add results to the leaderboard.`,
              head: branchName,
              base: context.ref.split('/').pop(),
            });
            
            core.setOutput('pr_number', pr.number);
            core.notice(`âœ… Created PR #${pr.number} with assessment results`);
